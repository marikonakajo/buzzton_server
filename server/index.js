!function(e){var n={};function r(t){if(n[t])return n[t].exports;var o=n[t]={i:t,l:!1,exports:{}};return e[t].call(o.exports,o,o.exports,r),o.l=!0,o.exports}r.m=e,r.c=n,r.d=function(e,n,t){r.o(e,n)||Object.defineProperty(e,n,{enumerable:!0,get:t})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,n){if(1&n&&(e=r(e)),8&n)return e;if(4&n&&"object"==typeof e&&e&&e.__esModule)return e;var t=Object.create(null);if(r.r(t),Object.defineProperty(t,"default",{enumerable:!0,value:e}),2&n&&"string"!=typeof e)for(var o in e)r.d(t,o,function(n){return e[n]}.bind(null,o));return t},r.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(n,"a",n),n},r.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},r.p="",r(r.s=13)}([function(e,n){e.exports=require("mongoose")},function(e,n){e.exports=require("fs")},function(e,n){e.exports=require("winston")},function(e,n){e.exports=require("express")},function(e,n){e.exports=require("express-session")},function(e,n){e.exports=require("body-parser")},function(e,n){e.exports=require("compression")},function(e,n){e.exports=require("connect-mongo")},function(e,n){e.exports=require("bluebird")},function(e,n){e.exports=require("path")},function(e,n){e.exports=require("multer")},function(e,n){e.exports=require("uuid/v1")},function(e,n){e.exports=require("fluent-ffmpeg")},function(e,n,r){"use strict";r.r(n);var t=r(3),o=r(6),i=r(4),s=r(5),u=r(7),a=r(8),d=r(0),c=r(9),l=r(1),f=r(10),p=r(11),m=r(12),v=r(2);var g,b=v.createLogger({format:v.format.json(),transports:[new v.transports.Console({level:"error"}),new v.transports.File({filename:"debug.log",level:"debug"})]}),y=d.Schema,x=new d.Schema({id:String,user:{type:y.Types.ObjectId,ref:"User"},url:String,vaild:Boolean,rank:Number,comments:[{type:y.Types.ObjectId,ref:"Comment"}],tags:[String],message:String,reactions:{like:Number}},{timestamps:!0}),O=d.model("Video",x),h=d.Schema,k=new h({name:String,id:String}),j=new h({user:{type:h.Types.ObjectId,ref:"User"},like:Number,text:String}),S=d.model("User",k),q=d.model("Comment",j),w=S,P=c.join("upload"),_=t.Router(),T=f({dest:P});function z(e){var n=[];return e&&(n=e.match(/\#[^\s]+/g)),n||[]}w.findOne({id:"a"},function(e,n){g=n}),_.get("/",function(e,n){O.find().populate("user").exec(function(e,r){return n.json({videos:r})})}),_.get("/:id",function(e,n){var r=e.params.id;O.findOne({vaild:!0,id:r}).populate("user").populate({path:"comments",populate:{path:"user",model:w}}).exec(function(e,r){return n.json(r)})}),_.post("/",T.single("video"),function(e,n){var r=p();if(!e.file)return b.error("No file found in uploaded request body."),n.status(400).json({message:"No file found in uploaded request body."});if(e.file.path&&/\.mp4/i.test(e.file.originalname)){var t=[],o="";e.body.message&&(t=z(o=e.body.message));var i=new O({id:r,user:g,url:"/videos/"+r+"/video.m3u8",vaild:!0,rank:1,comments:[],tags:t,message:o,reactions:{like:0}});l.mkdirSync("out/"+r);var s="out/"+r+"/video.m3u8";return m(l.createReadStream(e.file.path)).outputOptions(["-c:v copy","-c:a copy"]).on("progress",function(e,n,r){b.debug("progress: "+e.percent+"%")}).on("stderr",function(e){b.error("stderr: "+e)}).on("error",function(n,r,t){b.error("Cannot process video: "+n.message),l.unlink(e.file.path,function(e){e&&b.error("error. unlink file")})}).on("end",function(n,t){b.info("Transcoding succeeded! video-id:"+r+", uploaded by "+g.name),i.save(function(e){e&&b.error(e)}),l.unlink(e.file.path,function(e){e&&b.error("error. unlink file")})}).output(s).run(),n.json(i)}return n.send(400)}),_.put("/:id",function(e,n){var r=e.params.id,t=e.body.message;if(t){var o=z(t);O.findOne({vaild:!0,id:r}).populate("user").populate({path:"comments",populate:{path:"user",model:w}}).exec(function(e,r){return r.message=t,r.tags=o,r.save(),n.json(r)})}return n.send(400)}),_.patch("/:id",function(e,n){var r=e.params.id,t=e.body.valid;return null!=t&&O.findOne({id:r}).exec(function(e,n){n.vaild=t,n.save()}),n.send(200)}),_.delete("/:id",function(e,n){var r=e.params.id;O.deleteOne({vaild:!1,id:r}).exec(function(e){return n.send(200)})}),_.post("/:id/comments",function(e,n){if(e.body&&e.body.message){var r=e.params.id,t=e.body.message,o=new q({text:t,user:g,like:0});return O.findOne({vaild:!0,id:r}).exec(function(e,n){n&&(o.save(),n.comments.push(o._id),n.save())}),n.send(200)}return n.send(400)}),_.delete("/:id/comments/:commentid",function(e,n){var r=e.params.id,t=e.params.commentid;return O.findOne({vaild:!0,id:r}).exec(function(e,n){if(n){var r=n.comments;r.forEach(function(e,n){e.id===t&&r.splice(n,1)}),n.comments=r,q.deleteOne({_id:t}).exec(),n.save()}}),n.send(200)}),_.post("/:id/reactions/like",function(e,n){if(e.body&&e.body.message){var r=e.params.id;return O.findOne({vaild:!0,id:r}).exec(function(e,n){n&&(n.reactions.like=n.reactions.like+1,n.save())}),n.send(200)}return n.send(400)}),_.delete("/:id/reactions/like",function(e,n){if(e.body&&e.body.message){var r=e.params.id;return O.findOne({vaild:!0,id:r}).exec(function(e,n){n&&(n.reactions.like=n.reactions.like-1,n.reactions.like<0&&(n.reactions.like=0),n.save())}),n.send(200)}return n.send(400)});var M=_,N=u(i),R="mongodb://mongodb/buzztondb";d.Promise=a,d.connect(R,{useNewUrlParser:!0,autoReconnect:!0,reconnectTries:10,reconnectInterval:10}).then(function(){}).catch(function(e){console.log("MongoDB connection error. Please make sure MongoDB is running. "+e)});var U=t();U.set("port",process.env.PORT||8888),U.use(o()),U.use(s.json()),U.use(s.urlencoded({limit:"5mb",extended:!0,parameterLimit:1e5})),U.use(i({resave:!0,saveUninitialized:!0,secret:"buzztonoton",store:new N({url:R,autoReconnect:!0})})),U.use("/videos",M),U.get("/version",function(e,n){return n.json({type:"server_version",data:{version:1.01,description:"buzzton server"}})});var C=U,I=C.listen(C.get("port"),function(){console.log("  App is running at http://localhost:%d in %s mode",C.get("port"),C.get("env"))});n.default=I}]);