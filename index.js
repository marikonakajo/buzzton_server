!function(e){var n={};function r(t){if(n[t])return n[t].exports;var o=n[t]={i:t,l:!1,exports:{}};return e[t].call(o.exports,o,o.exports,r),o.l=!0,o.exports}r.m=e,r.c=n,r.d=function(e,n,t){r.o(e,n)||Object.defineProperty(e,n,{enumerable:!0,get:t})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,n){if(1&n&&(e=r(e)),8&n)return e;if(4&n&&"object"==typeof e&&e&&e.__esModule)return e;var t=Object.create(null);if(r.r(t),Object.defineProperty(t,"default",{enumerable:!0,value:e}),2&n&&"string"!=typeof e)for(var o in e)r.d(t,o,function(n){return e[n]}.bind(null,o));return t},r.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(n,"a",n),n},r.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},r.p="",r(r.s=13)}([function(e,n){e.exports=require("mongoose")},function(e,n){e.exports=require("winston")},function(e,n){e.exports=require("fs")},function(e,n){e.exports=require("express")},function(e,n){e.exports=require("express-session")},function(e,n){e.exports=require("body-parser")},function(e,n){e.exports=require("compression")},function(e,n){e.exports=require("connect-mongo")},function(e,n){e.exports=require("bluebird")},function(e,n){e.exports=require("path")},function(e,n){e.exports=require("multer")},function(e,n){e.exports=require("uuid/v1")},function(e,n){e.exports=require("fluent-ffmpeg")},function(e,n,r){"use strict";r.r(n);var t=r(3),o=r(6),i=r(4),s=r(5),u=r(7),a=r(8),d=r(0),c=r(1);var f=c.createLogger({format:c.format.json(),transports:[new c.transports.Console({level:"error"}),new c.transports.File({filename:"debug.log",level:"debug"})]}),l=d.Schema,p=new l({name:String,id:String}),m=new l({user:{type:l.Types.ObjectId,ref:"User"},like:Number,text:String}),v=d.model("User",p),g=d.model("Comment",m),b=v,y=r(9),x=r(2),h=r(10),O=r(11),k=r(12),j=d.Schema,S=new d.Schema({id:String,user:{type:j.Types.ObjectId,ref:"User"},url:String,vaild:Boolean,rank:Number,comments:[{type:j.Types.ObjectId,ref:"Comment"}],tags:[String],message:String,reactions:{like:Number}},{timestamps:!0}),q=d.model("Video",S),w=y.join("upload"),z=t.Router(),P=h({dest:w});function _(e){var n=[];return e&&(n=e.match(/\#[^\s]+/g)),n||[]}z.get("/",function(e,n){f.debug(e.session.user),q.find().populate("user").exec(function(e,r){return n.json({videos:r})})}),z.get("/:id",function(e,n){var r=e.params.id;q.findOne({vaild:!0,id:r}).populate("user").populate({path:"comments",populate:{path:"user",model:b}}).exec(function(e,r){return n.json(r)})}),z.post("/",P.single("video"),function(e,n){var r=O();if(!e.file)return f.error("No file found in uploaded request body."),n.status(400).json({message:"No file found in uploaded request body."});if(e.file.path&&/\.mp4/i.test(e.file.originalname)){var t=[],o="";e.body.message&&(t=_(o=e.body.message));var i=new q({id:r,user:e.session.user,url:"/videos/"+r+"/video.m3u8",vaild:!0,rank:1,comments:[],tags:t,message:o,reactions:{like:0}});x.mkdirSync("out/"+r);var s="out/"+r+"/video.m3u8";return k(x.createReadStream(e.file.path)).outputOptions(["-c:v copy","-c:a copy"]).on("progress",function(e,n,r){f.debug("progress: "+e.percent+"%")}).on("stderr",function(e){f.error("stderr: "+e)}).on("error",function(n,r,t){f.error("Cannot process video: "+n.message),x.unlink(e.file.path,function(e){e&&f.error("error. unlink file")})}).on("end",function(n,t){f.info("Transcoding succeeded! video-id:"+r+", uploaded by "+e.session.user.name),i.save(function(e){e&&f.error(e)}),x.unlink(e.file.path,function(e){e&&f.error("error. unlink file")})}).output(s).run(),n.json(i)}return n.send(400)}),z.put("/:id",function(e,n){var r=e.params.id,t=e.body.message;if(t){var o=_(t);q.findOne({vaild:!0,id:r}).populate("user").populate({path:"comments",populate:{path:"user",model:b}}).exec(function(e,r){return r.message=t,r.tags=o,r.save(),n.json(r)})}return n.send(400)}),z.patch("/:id",function(e,n){var r=e.params.id,t=e.body.valid;return null!=t&&q.findOne({id:r}).exec(function(e,n){n.vaild=t,n.save()}),n.send(200)}),z.delete("/:id",function(e,n){var r=e.params.id;q.deleteOne({vaild:!1,id:r}).exec(function(e){return n.send(200)})}),z.post("/:id/comments",function(e,n){if(e.body&&e.body.message){var r=e.params.id,t=e.body.message,o=new g({text:t,user:e.session.user,like:0});return q.findOne({vaild:!0,id:r}).exec(function(e,n){n&&(o.save(),n.comments.push(o._id),n.save())}),n.send(200)}return n.send(400)}),z.delete("/:id/comments/:commentid",function(e,n){var r=e.params.id,t=e.params.commentid;return q.findOne({vaild:!0,id:r}).exec(function(e,n){if(n){var r=n.comments;r.forEach(function(e,n){e.id===t&&r.splice(n,1)}),n.comments=r,g.deleteOne({_id:t}).exec(),n.save()}}),n.send(200)}),z.post("/:id/reactions/like",function(e,n){if(e.body&&e.body.message){var r=e.params.id;return q.findOne({vaild:!0,id:r}).exec(function(e,n){n&&(n.reactions.like=n.reactions.like+1,n.save())}),n.send(200)}return n.send(400)}),z.delete("/:id/reactions/like",function(e,n){if(e.body&&e.body.message){var r=e.params.id;return q.findOne({vaild:!0,id:r}).exec(function(e,n){n&&(n.reactions.like=n.reactions.like-1,n.reactions.like<0&&(n.reactions.like=0),n.save())}),n.send(200)}return n.send(400)});var T=z,M=u(i),N="mongodb://mongodb/buzztondb";d.Promise=a,d.connect(N,{useNewUrlParser:!0,autoReconnect:!0,reconnectTries:10,reconnectInterval:10}).then(function(){}).catch(function(e){console.log("MongoDB connection error. Please make sure MongoDB is running. "+e)});var R=t();R.set("port",process.env.PORT||8888),R.use(o()),R.use(s.json()),R.use(s.urlencoded({limit:"5mb",extended:!0,parameterLimit:1e5})),R.use(i({resave:!0,saveUninitialized:!0,secret:"buzztonoton",store:new M({url:N,autoReconnect:!0})})),R.use(function(e,n,r){if(e.headers.authorization){var t=e.headers.authorization.split(" ")[1],o=Buffer.from(t,"base64").toString("ascii").split(":")[0];f.debug(o),b.findOne({id:o},function(n,r){e.session.user=r})}r()}),R.use("/videos",T),R.get("/version",function(e,n){return n.json({type:"server_version",data:{version:1.01,description:"buzzton server"}})});var U=R,B=U.listen(U.get("port"),function(){console.log("  App is running at http://localhost:%d in %s mode",U.get("port"),U.get("env"))});n.default=B}]);